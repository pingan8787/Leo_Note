<html>
<head>
  <title>javascript 闭包</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/304720 (zh-CN, DDL); Windows/10.0.14393 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1623"/>
<h1>javascript 闭包</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2017/1/13 星期五 0:08</i></td></tr>
<tr><td><b>更新时间：</b></td><td><i>2017/1/13 星期五 0:09</i></td></tr>
<tr><td><b>作者：</b></td><td><i>王平安</i></td></tr>
</table>
</div>
<br/>

<div>
<span><div><h3 style="margin: 0px 0px 15px; font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-weight: normal; color: rgb(68, 68, 68); text-transform: none; font-size: 18px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">函数作为返回值</h3><p style="margin: 15px 0px; word-wrap: break-word; white-space: pre-wrap; color: rgb(102, 102, 102); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">高阶函数除了可以接受函数作为参数外，还可以把函数作为结果值返回。</p><p style="margin: 15px 0px; word-wrap: break-word; white-space: pre-wrap; color: rgb(102, 102, 102); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">我们来实现一个对<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">Array</code>的求和。通常情况下，求和的函数是这样定义的：</p><pre style="margin: 15px 0px; padding: 10px; background: rgb(250, 250, 250); font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(68, 68, 68); tab-size: 4; overflow: auto; border: 1px solid rgb(221, 221, 221); border-radius: 3px; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code><span style="color: rgb(51, 51, 51); font-weight: bold;">function</span> <span style="color: rgb(51, 51, 51); font-weight: normal;">sum</span>(arr) {
    <span style="color: rgb(51, 51, 51); font-weight: bold;">return</span> arr.reduce(<span style="color: rgb(51, 51, 51); font-weight: bold;">function</span> (x, y) {
        <span style="color: rgb(51, 51, 51); font-weight: bold;">return</span> x + y;
    });
}

sum([<span style="color: rgb(0, 153, 153);">1</span>, <span style="color: rgb(0, 153, 153);">2</span>, <span style="color: rgb(0, 153, 153);">3</span>, <span style="color: rgb(0, 153, 153);">4</span>, <span style="color: rgb(0, 153, 153);">5</span>]); <span style="color: rgb(153, 153, 136); font-style: italic;">// 15</span></code></pre><p style="margin: 15px 0px; word-wrap: break-word; white-space: pre-wrap; color: rgb(102, 102, 102); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">但是，如果不需要立刻求和，而是在后面的代码中，根据需要再计算怎么办？可以不返回求和的结果，而是返回求和的函数！</p><pre style="margin: 15px 0px; padding: 10px; background: rgb(250, 250, 250); font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(68, 68, 68); tab-size: 4; overflow: auto; border: 1px solid rgb(221, 221, 221); border-radius: 3px; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code><span style="color: rgb(51, 51, 51); font-weight: bold;">function</span> <span style="color: rgb(51, 51, 51); font-weight: normal;">lazy_sum</span>(arr) {
    <span style="color: rgb(51, 51, 51); font-weight: bold;">var</span> sum = <span style="color: rgb(51, 51, 51); font-weight: bold;">function</span> () {
        <span style="color: rgb(51, 51, 51); font-weight: bold;">return</span> arr.reduce(<span style="color: rgb(51, 51, 51); font-weight: bold;">function</span> (x, y) {
            <span style="color: rgb(51, 51, 51); font-weight: bold;">return</span> x + y;
        });
    }
    <span style="color: rgb(51, 51, 51); font-weight: bold;">return</span> sum;
}
</code></pre><p style="margin: 15px 0px; word-wrap: break-word; white-space: pre-wrap; color: rgb(102, 102, 102); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">当我们调用<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">lazy_sum()</code>时，返回的并不是求和结果，而是求和函数：</p><pre style="margin: 15px 0px; padding: 10px; background: rgb(250, 250, 250); font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(68, 68, 68); tab-size: 4; overflow: auto; border: 1px solid rgb(221, 221, 221); border-radius: 3px; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code><span style="color: rgb(51, 51, 51); font-weight: bold;">var</span> f = lazy_sum([<span style="color: rgb(0, 153, 153);">1</span>, <span style="color: rgb(0, 153, 153);">2</span>, <span style="color: rgb(0, 153, 153);">3</span>, <span style="color: rgb(0, 153, 153);">4</span>, <span style="color: rgb(0, 153, 153);">5</span>]); <span style="color: rgb(153, 153, 136); font-style: italic;">// function sum()</span></code></pre><p style="margin: 15px 0px; word-wrap: break-word; white-space: pre-wrap; color: rgb(102, 102, 102); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">调用函数<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">f</code>时，才真正计算求和的结果：</p><pre style="margin: 15px 0px; padding: 10px; background: rgb(250, 250, 250); font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(68, 68, 68); tab-size: 4; overflow: auto; border: 1px solid rgb(221, 221, 221); border-radius: 3px; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code>f(); <span style="color: rgb(0, 153, 38);">//</span> <span style="color: rgb(0, 153, 153);">15</span></code></pre><p style="margin: 15px 0px; word-wrap: break-word; white-space: pre-wrap; color: rgb(102, 102, 102); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">在这个例子中，我们在函数<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">lazy_sum</code>中又定义了函数<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">sum</code>，并且，内部函数<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">sum</code>可以引用外部函数<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">lazy_sum</code>的参数和局部变量，当<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">lazy_sum</code>返回函数<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">sum</code>时，相关参数和变量都保存在返回的函数中，这种称为“闭包（Closure）”的程序结构拥有极大的威力。</p><p style="margin: 15px 0px; word-wrap: break-word; white-space: pre-wrap; color: rgb(102, 102, 102); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">请再注意一点，当我们调用<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">lazy_sum()</code>时，每次调用都会返回一个新的函数，即使传入相同的参数：</p><pre style="margin: 15px 0px; padding: 10px; background: rgb(250, 250, 250); font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(68, 68, 68); tab-size: 4; overflow: auto; border: 1px solid rgb(221, 221, 221); border-radius: 3px; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code><span style="color: rgb(51, 51, 51); font-weight: bold;">var</span> f1 = lazy_sum([<span style="color: rgb(0, 153, 153);">1</span>, <span style="color: rgb(0, 153, 153);">2</span>, <span style="color: rgb(0, 153, 153);">3</span>, <span style="color: rgb(0, 153, 153);">4</span>, <span style="color: rgb(0, 153, 153);">5</span>]);
<span style="color: rgb(51, 51, 51); font-weight: bold;">var</span> f2 = lazy_sum([<span style="color: rgb(0, 153, 153);">1</span>, <span style="color: rgb(0, 153, 153);">2</span>, <span style="color: rgb(0, 153, 153);">3</span>, <span style="color: rgb(0, 153, 153);">4</span>, <span style="color: rgb(0, 153, 153);">5</span>]);
f1 === f2; <span style="color: rgb(153, 153, 136); font-style: italic;">// false</span></code></pre><p style="margin: 15px 0px; word-wrap: break-word; white-space: pre-wrap; color: rgb(102, 102, 102); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">f1()</code>和<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">f2()</code>的调用结果互不影响。</p><h3 style="margin: 25px 0px 15px; font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-weight: normal; color: rgb(68, 68, 68); text-transform: none; font-size: 18px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">闭包</h3><p style="margin: 15px 0px; word-wrap: break-word; white-space: pre-wrap; color: rgb(102, 102, 102); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">注意到返回的函数在其定义内部引用了局部变量<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">arr</code>，所以，当一个函数返回了一个函数后，其内部的局部变量还被新函数引用，所以，闭包用起来简单，实现起来可不容易。</p><p style="margin: 15px 0px; word-wrap: break-word; white-space: pre-wrap; color: rgb(102, 102, 102); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">另一个需要注意的问题是，返回的函数并没有立刻执行，而是直到调用了<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">f()</code>才执行。我们来看一个例子：</p><pre style="margin: 15px 0px; padding: 10px; background: rgb(250, 250, 250); font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(68, 68, 68); tab-size: 4; overflow: auto; border: 1px solid rgb(221, 221, 221); border-radius: 3px; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code><span style="color: rgb(51, 51, 51); font-weight: bold;">function</span> <span style="color: rgb(51, 51, 51); font-weight: normal;">count</span>() {
    <span style="color: rgb(51, 51, 51); font-weight: bold;">var</span> arr = [];
    <span style="color: rgb(51, 51, 51); font-weight: bold;">for</span> (<span style="color: rgb(51, 51, 51); font-weight: bold;">var</span> i=<span style="color: rgb(0, 153, 153);">1</span>; i&lt;=<span style="color: rgb(0, 153, 153);">3</span>; i++) {
        arr.push(<span style="color: rgb(51, 51, 51); font-weight: bold;">function</span> () {
            <span style="color: rgb(51, 51, 51); font-weight: bold;">return</span> i * i;
        });
    }
    <span style="color: rgb(51, 51, 51); font-weight: bold;">return</span> arr;
}

<span style="color: rgb(51, 51, 51); font-weight: bold;">var</span> results = count();
<span style="color: rgb(51, 51, 51); font-weight: bold;">var</span> f1 = results[<span style="color: rgb(0, 153, 153);">0</span>];
<span style="color: rgb(51, 51, 51); font-weight: bold;">var</span> f2 = results[<span style="color: rgb(0, 153, 153);">1</span>];
<span style="color: rgb(51, 51, 51); font-weight: bold;">var</span> f3 = results[<span style="color: rgb(0, 153, 153);">2</span>];
</code></pre><p style="margin: 15px 0px; word-wrap: break-word; white-space: pre-wrap; color: rgb(102, 102, 102); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">在上面的例子中，每次循环，都创建了一个新的函数，然后，把创建的3个函数都添加到一个<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">Array</code>中返回了。</p><p style="margin: 15px 0px; word-wrap: break-word; white-space: pre-wrap; color: rgb(102, 102, 102); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">你可能认为调用<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">f1()</code>，<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">f2()</code>和<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">f3()</code>结果应该是<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">1</code>，<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">4</code>，<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">9</code>，但实际结果是：</p><pre style="margin: 15px 0px; padding: 10px; background: rgb(250, 250, 250); font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(68, 68, 68); tab-size: 4; overflow: auto; border: 1px solid rgb(221, 221, 221); border-radius: 3px; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code>f1(); <span style="color: rgb(0, 153, 38);">//</span> <span style="color: rgb(0, 153, 153);">16</span>
f2(); <span style="color: rgb(0, 153, 38);">//</span> <span style="color: rgb(0, 153, 153);">16</span>
f3(); <span style="color: rgb(0, 153, 38);">//</span> <span style="color: rgb(0, 153, 153);">16</span></code></pre><p style="margin: 15px 0px; word-wrap: break-word; white-space: pre-wrap; color: rgb(102, 102, 102); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">全部都是<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">16</code>！原因就在于返回的函数引用了变量<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">i</code>，但它并非立刻执行。等到3个函数都返回时，它们所引用的变量<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">i</code>已经变成了<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">4</code>，因此最终结果为<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">16</code>。</p><p style="margin: 15px 0px; word-wrap: break-word; white-space: pre-wrap; color: rgb(102, 102, 102); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">返回闭包时牢记的一点就是：返回函数不要引用任何循环变量，或者后续会发生变化的变量。</p><p style="margin: 15px 0px; word-wrap: break-word; white-space: pre-wrap; color: rgb(102, 102, 102); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">如果一定要引用循环变量怎么办？方法是再创建一个函数，用该函数的参数绑定循环变量当前的值，无论该循环变量后续如何更改，已绑定到函数参数的值不变：</p><pre style="margin: 15px 0px; padding: 10px; background: rgb(250, 250, 250); font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(68, 68, 68); tab-size: 4; overflow: auto; border: 1px solid rgb(221, 221, 221); border-radius: 3px; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code><span style="color: rgb(51, 51, 51); font-weight: bold;">function</span> <span style="color: rgb(51, 51, 51); font-weight: normal;">count</span>() {
    <span style="color: rgb(51, 51, 51); font-weight: bold;">var</span> arr = [];
    <span style="color: rgb(51, 51, 51); font-weight: bold;">for</span> (<span style="color: rgb(51, 51, 51); font-weight: bold;">var</span> i=<span style="color: rgb(0, 153, 153);">1</span>; i&lt;=<span style="color: rgb(0, 153, 153);">3</span>; i++) {
        arr.push((<span style="color: rgb(51, 51, 51); font-weight: bold;">function</span> (n) {
            <span style="color: rgb(51, 51, 51); font-weight: bold;">return</span> <span style="color: rgb(51, 51, 51); font-weight: bold;">function</span> () {
                <span style="color: rgb(51, 51, 51); font-weight: bold;">return</span> n * n;
            }
        })(i));
    }
    <span style="color: rgb(51, 51, 51); font-weight: bold;">return</span> arr;
}

<span style="color: rgb(51, 51, 51); font-weight: bold;">var</span> results = count();
<span style="color: rgb(51, 51, 51); font-weight: bold;">var</span> f1 = results[<span style="color: rgb(0, 153, 153);">0</span>];
<span style="color: rgb(51, 51, 51); font-weight: bold;">var</span> f2 = results[<span style="color: rgb(0, 153, 153);">1</span>];
<span style="color: rgb(51, 51, 51); font-weight: bold;">var</span> f3 = results[<span style="color: rgb(0, 153, 153);">2</span>];

f1(); <span style="color: rgb(153, 153, 136); font-style: italic;">// 1</span>
f2(); <span style="color: rgb(153, 153, 136); font-style: italic;">// 4</span>
f3(); <span style="color: rgb(153, 153, 136); font-style: italic;">// 9</span></code></pre><p style="margin: 15px 0px; word-wrap: break-word; white-space: pre-wrap; color: rgb(102, 102, 102); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">注意这里用了一个“创建一个匿名函数并立刻执行”的语法：</p><pre style="margin: 15px 0px; padding: 10px; background: rgb(250, 250, 250); font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(68, 68, 68); tab-size: 4; overflow: auto; border: 1px solid rgb(221, 221, 221); border-radius: 3px; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code>(<span style="color: rgb(51, 51, 51); font-weight: bold;">function</span> (x) {
    <span style="color: rgb(51, 51, 51); font-weight: bold;">return</span> x * x;
})(<span style="color: rgb(0, 153, 153);">3</span>); <span style="color: rgb(153, 153, 136); font-style: italic;">// 9</span></code></pre><p style="margin: 15px 0px; word-wrap: break-word; white-space: pre-wrap; color: rgb(102, 102, 102); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">理论上讲，创建一个匿名函数并立刻执行可以这么写：</p><pre style="margin: 15px 0px; padding: 10px; background: rgb(250, 250, 250); font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(68, 68, 68); tab-size: 4; overflow: auto; border: 1px solid rgb(221, 221, 221); border-radius: 3px; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code><span style="color: rgb(51, 51, 51); font-weight: bold;">function</span> (x) { <span style="color: rgb(51, 51, 51); font-weight: bold;">return</span> x * x } (<span style="color: rgb(0, 153, 153);">3</span>);
</code></pre><p style="margin: 15px 0px; word-wrap: break-word; white-space: pre-wrap; color: rgb(102, 102, 102); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">但是由于JavaScript语法解析的问题，会报SyntaxError错误，因此需要用括号把整个函数定义括起来：</p><pre style="margin: 15px 0px; padding: 10px; background: rgb(250, 250, 250); font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(68, 68, 68); tab-size: 4; overflow: auto; border: 1px solid rgb(221, 221, 221); border-radius: 3px; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code>(<span style="color: rgb(51, 51, 51); font-weight: bold;">function</span> (x) { <span style="color: rgb(51, 51, 51); font-weight: bold;">return</span> x * x }) (<span style="color: rgb(0, 153, 153);">3</span>);
</code></pre></div><div><br/></div><div style="margin: 15px 0px; font-style: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div><span style="color: rgb(102, 102, 102);"><span style="font-size: 14px;"><span style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;">通常，一个立即执行的匿名函数可以把函数体拆开，一般这么写：</span></span></span></div><div style="color: rgb(102, 102, 102); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><pre style="margin: 15px 0px; padding: 10px; background: rgb(250, 250, 250); font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(68, 68, 68); tab-size: 4; overflow: auto; border: 1px solid rgb(221, 221, 221); border-radius: 3px; word-break: break-all; word-wrap: break-word; white-space: pre-wrap;"><code>(<span style="color: rgb(51, 51, 51); font-weight: bold;">function</span> (x) {
    <span style="color: rgb(51, 51, 51); font-weight: bold;">return</span> x * x;
})(<span style="color: rgb(0, 153, 153);">3</span>);
</code></pre><p style="margin: 15px 0px; word-wrap: break-word; white-space: pre-wrap;">说了这么多，难道闭包就是为了返回一个函数然后延迟执行吗？</p><p style="margin: 15px 0px; word-wrap: break-word; white-space: pre-wrap;">当然不是！闭包有非常强大的功能。举个栗子：</p><p style="margin: 15px 0px; word-wrap: break-word; white-space: pre-wrap;">在面向对象的程序设计语言里，比如Java和C++，要在对象内部封装一个私有变量，可以用<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">private</code>修饰一个成员变量。</p><p style="margin: 15px 0px; word-wrap: break-word; white-space: pre-wrap;">在没有<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">class</code>机制，只有函数的语言里，借助闭包，同样可以封装一个私有变量。我们用JavaScript创建一个计数器：</p><pre style="margin: 15px 0px; padding: 10px; background: rgb(250, 250, 250); font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(68, 68, 68); tab-size: 4; overflow: auto; border: 1px solid rgb(221, 221, 221); border-radius: 3px; word-break: break-all; word-wrap: break-word; white-space: pre-wrap;"><code><span style="color: rgb(221, 17, 68);">'use strict'</span>;

<span style="color: rgb(51, 51, 51); font-weight: bold;">function</span> <span style="color: rgb(51, 51, 51); font-weight: normal;">create_counter</span>(initial) {
    <span style="color: rgb(51, 51, 51); font-weight: bold;">var</span> x = initial || <span style="color: rgb(0, 153, 153);">0</span>;
    <span style="color: rgb(51, 51, 51); font-weight: bold;">return</span> {
        inc: <span style="color: rgb(51, 51, 51); font-weight: bold;">function</span> () {
            x += <span style="color: rgb(0, 153, 153);">1</span>;
            <span style="color: rgb(51, 51, 51); font-weight: bold;">return</span> x;
        }
    }
}
</code></pre><p style="margin: 15px 0px; word-wrap: break-word; white-space: pre-wrap;">它用起来像这样：</p><pre style="margin: 15px 0px; padding: 10px; background: rgb(250, 250, 250); font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(68, 68, 68); tab-size: 4; overflow: auto; border: 1px solid rgb(221, 221, 221); border-radius: 3px; word-break: break-all; word-wrap: break-word; white-space: pre-wrap;"><code><span style="color: rgb(51, 51, 51); font-weight: bold;">var</span> c1 = create_counter();
c1.inc(); <span style="color: rgb(153, 153, 136); font-style: italic;">// 1</span>
c1.inc(); <span style="color: rgb(153, 153, 136); font-style: italic;">// 2</span>
c1.inc(); <span style="color: rgb(153, 153, 136); font-style: italic;">// 3</span>

<span style="color: rgb(51, 51, 51); font-weight: bold;">var</span> c2 = create_counter(<span style="color: rgb(0, 153, 153);">10</span>);
c2.inc(); <span style="color: rgb(153, 153, 136); font-style: italic;">// 11</span>
c2.inc(); <span style="color: rgb(153, 153, 136); font-style: italic;">// 12</span>
c2.inc(); <span style="color: rgb(153, 153, 136); font-style: italic;">// 13</span></code></pre><p style="margin: 15px 0px; word-wrap: break-word; white-space: pre-wrap;">在返回的对象中，实现了一个闭包，该闭包携带了局部变量<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">x</code>，并且，从外部代码根本无法访问到变量<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">x</code>。换句话说，闭包就是携带状态的函数，并且它的状态可以完全对外隐藏起来。</p><p style="margin: 15px 0px; word-wrap: break-word; white-space: pre-wrap;">闭包还可以把多参数的函数变成单参数的函数。例如，要计算x<sup style="font-size: 12px; position: relative; vertical-align: baseline; top: -0.5em;">y</sup>可以用<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">Math.pow(x, y)</code>函数，不过考虑到经常计算x<sup style="font-size: 12px; position: relative; vertical-align: baseline; top: -0.5em;">2</sup>或x<sup style="font-size: 12px; position: relative; vertical-align: baseline; top: -0.5em;">3</sup>，我们可以利用闭包创建新的函数<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">pow2</code>和<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">pow3</code>：</p><pre style="margin: 15px 0px; padding: 10px; background: rgb(250, 250, 250); font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(68, 68, 68); tab-size: 4; overflow: auto; border: 1px solid rgb(221, 221, 221); border-radius: 3px; word-break: break-all; word-wrap: break-word; white-space: pre-wrap;"><code><span style="color: rgb(51, 51, 51); font-weight: bold;">function</span> <span style="color: rgb(51, 51, 51); font-weight: normal;">make_pow</span>(n) {
    <span style="color: rgb(51, 51, 51); font-weight: bold;">return</span> <span style="color: rgb(51, 51, 51); font-weight: bold;">function</span> (x) {
        <span style="color: rgb(51, 51, 51); font-weight: bold;">return</span> Math.pow(x, n);
    }
}

<span style="color: rgb(153, 153, 136); font-style: italic;">// 创建两个新函数:</span><span style="color: rgb(51, 51, 51); font-weight: bold;">var</span> pow2 = make_pow(<span style="color: rgb(0, 153, 153);">2</span>);
<span style="color: rgb(51, 51, 51); font-weight: bold;">var</span> pow3 = make_pow(<span style="color: rgb(0, 153, 153);">3</span>);

pow2(<span style="color: rgb(0, 153, 153);">5</span>); <span style="color: rgb(153, 153, 136); font-style: italic;">// 25</span>
pow3(<span style="color: rgb(0, 153, 153);">7</span>); <span style="color: rgb(153, 153, 136); font-style: italic;">// 343</span></code></pre><h3 style="margin: 25px 0px 15px; font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-weight: normal; color: rgb(68, 68, 68); text-transform: none; font-size: 18px;">脑洞大开</h3><p style="margin: 15px 0px; word-wrap: break-word; white-space: pre-wrap;">很久很久以前，有个叫阿隆佐·邱奇的帅哥，发现只需要用函数，就可以用计算机实现运算，而不需要<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">0</code>、<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">1</code>、<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">2</code>、<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">3</code>这些数字和<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">+</code>、<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">-</code>、<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">*</code>、<code style="font-size: 12px; font-family: Consolas, monospace, serif; color: rgb(221, 0, 85); white-space: nowrap; padding: 0px 4px; border: 1px solid rgb(221, 221, 221); border-radius: 3px; background: rgb(250, 250, 250);">/</code>这些符号。</p><p style="margin: 15px 0px; word-wrap: break-word; white-space: pre-wrap;">JavaScript支持函数，所以可以用JavaScript用函数来写这些计算。来试试：</p><pre style="margin: 0px; padding: 6px; background: rgb(250, 250, 250); font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 14px; font-family: Consolas, monospace, serif; color: rgb(68, 68, 68); tab-size: 4; overflow: auto; border-top: 1px solid rgb(221, 221, 221); border-right: 1px solid rgb(221, 221, 221); border-bottom: none; border-left: 1px solid rgb(221, 221, 221); border-image: initial; border-radius: 3px 3px 0px 0px; word-break: break-all; word-wrap: break-word; white-space: pre-wrap;">
'use strict';

// 定义数字0:
var zero = function (f) {
    return function (x) {
        return x;
    }
};

// 定义数字1:
var one = function (f) {
    return function (x) {
        return f(x);
    }
};

// 定义加法:
function add(n, m) {
    return function (f) {
        return function (x) {
            return m(f)(n(f)(x));
        }
    }
}
</pre></div><div><span style="color: rgb(68, 68, 68);"><span style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;"><span style="font-size: 18px;"><br/></span></span></span></div></div></span>
</div></body></html> 