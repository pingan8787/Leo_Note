<html>
<head>
  <title>3-ES6 中的 Set、Map 和 WeakMap</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/304720 (zh-CN, DDL); Windows/10.0.14393 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1580"/>
<h1>3-ES6 中的 Set、Map 和 WeakMap</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2017/2/4 星期六 11:29</i></td></tr>
<tr><td><b>更新时间：</b></td><td><i>2017/2/4 星期六 11:34</i></td></tr>
<tr><td><b>作者：</b></td><td><i>王平安</i></td></tr>
</table>
</div>
<br/>

<div>
<span><div><p style="margin: 15px 0px 0px; padding: 0px; color: rgb(68, 68, 68); font-family: Arial, &quot;Hiragino Sans GB&quot;, 冬青黑, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Helvetica, Tahoma, &quot;Arial sans-serif&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">ES6 新增了几种集合类型，本文介绍 <a href="http://people.mozilla.org/~jorendorff/es6-draft.html#sec-23.2" style="margin: 0px; padding: 0px; color: rgb(36, 121, 204); text-decoration: none;">Set</a>、<a href="http://people.mozilla.org/~jorendorff/es6-draft.html#sec-23.1" style="margin: 0px; padding: 0px; color: rgb(36, 121, 204); text-decoration: none;">Map</a> 和 <a href="http://people.mozilla.org/~jorendorff/es6-draft.html#sec-23.3" style="margin: 0px; padding: 0px; color: rgb(36, 121, 204); text-decoration: none;">WeakMap</a>。比较新的 Firefox、Chrome（需要在 about:flags 启用实验性 JavaScript）以及 IE11 都有不同程度的实现。需要注意的是，ES6 规范会一直调整，本文只以当前规范及浏览器实现为准。</p><h3 style="margin: 15px 0px 0px; padding: 0px; font-size: 1.3em; color: rgb(68, 68, 68); font-family: Arial, &quot;Hiragino Sans GB&quot;, 冬青黑, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Helvetica, Tahoma, &quot;Arial sans-serif&quot;; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><a name="toc-0" style="margin: 0px; padding: 0px; color: rgb(36, 121, 204); text-decoration: none;"></a>Set</h3><p style="margin: 15px 0px 0px; padding: 0px; color: rgb(68, 68, 68); font-family: Arial, &quot;Hiragino Sans GB&quot;, 冬青黑, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Helvetica, Tahoma, &quot;Arial sans-serif&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">Set 是 ES6 新增的有序列表集合，它不会包含重复项。之前我们通常用对象（Object）或者数组（Array）来实现没有重复项的集合。但对象会对 key 进行 toString() 操作，这会导致某些 key 会意外覆盖之前的数据；如果 key 本身是一个对象，toString() 也得不到想要的结果，如下：</p><pre style="margin: 15px 0px 0px; padding: 0.6em; background-color: rgb(248, 248, 248); border-left: 5px solid rgb(204, 204, 204); color: rgb(93, 106, 106); font-size: 14px; overflow: hidden; position: relative; white-space: pre-wrap; word-break: break-word; word-wrap: break-word; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><b style="margin: 0px; padding: 0px; color: rgb(238, 238, 238); font-family: Consolas, &quot;Liberation Mono&quot;, Courier, monospace; font-size: 60px; pointer-events: none; position: absolute; right: 10px; top: 10px;">JS</b><code style="margin: 0px; padding: 0px; background-color: transparent; border-radius: 0px; font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14px; vertical-align: middle; border: 0px; display: block; position: relative;"><span style="margin: 0px; padding: 0px; color: rgb(133, 153, 0);">var</span> o = {};

<span style="margin: 0px; padding: 0px; color: rgb(133, 153, 0);">var</span> key1 = <span style="margin: 0px; padding: 0px; color: rgb(42, 161, 152);">2</span>;
<span style="margin: 0px; padding: 0px; color: rgb(133, 153, 0);">var</span> key2 = { toString : <span style="margin: 0px; padding: 0px;"><span style="margin: 0px; padding: 0px; color: rgb(133, 153, 0);">function</span><span style="margin: 0px; padding: 0px;">()</span> </span>{ <span style="margin: 0px; padding: 0px; color: rgb(133, 153, 0);">return</span> <span style="margin: 0px; padding: 0px; color: rgb(42, 161, 152);">2</span> } };

<span style="margin: 0px; padding: 0px; color: rgb(133, 153, 0);">var</span> key3 = { x : <span style="margin: 0px; padding: 0px; color: rgb(42, 161, 152);">1</span> };
<span style="margin: 0px; padding: 0px; color: rgb(133, 153, 0);">var</span> key4 = { y : <span style="margin: 0px; padding: 0px; color: rgb(42, 161, 152);">2</span> };

o[key1] = <span style="margin: 0px; padding: 0px; color: rgb(42, 161, 152);">1</span>;
o[key2] = <span style="margin: 0px; padding: 0px; color: rgb(42, 161, 152);">2</span>;
o[key3] = <span style="margin: 0px; padding: 0px; color: rgb(42, 161, 152);">3</span>;
o[key4] = <span style="margin: 0px; padding: 0px; color: rgb(42, 161, 152);">4</span>;

<span style="margin: 0px; padding: 0px; color: rgb(153, 153, 153);">// o : Object {2: 2, [object Object]: 4}</span></code></pre><p style="margin: 15px 0px 0px; padding: 0px; color: rgb(68, 68, 68); font-family: Arial, &quot;Hiragino Sans GB&quot;, 冬青黑, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Helvetica, Tahoma, &quot;Arial sans-serif&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">数组可以存放任何类型的数据，不过数据除重需要自己实现。</p><p style="margin: 15px 0px 0px; padding: 0px; color: rgb(68, 68, 68); font-family: Arial, &quot;Hiragino Sans GB&quot;, 冬青黑, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Helvetica, Tahoma, &quot;Arial sans-serif&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">Set 支持 add(item) 方法，用来向 Set 添加任意类型的元素，如果已经添加过则自动忽略；has(item) 方法用来检测 Set 中是否存在指定元素；delete(item) 方法用来从 Set 中删除指定元素；clear() 用来清空 Set；获取 Set 集合长度用 size 属性。如下：</p><pre style="margin: 15px 0px 0px; padding: 0.6em; background-color: rgb(248, 248, 248); border-left: 5px solid rgb(204, 204, 204); color: rgb(93, 106, 106); font-size: 14px; overflow: hidden; position: relative; white-space: pre-wrap; word-break: break-word; word-wrap: break-word; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><b style="margin: 0px; padding: 0px; color: rgb(238, 238, 238); font-family: Consolas, &quot;Liberation Mono&quot;, Courier, monospace; font-size: 60px; pointer-events: none; position: absolute; right: 10px; top: 10px;">JS</b><code style="margin: 0px; padding: 0px; background-color: transparent; border-radius: 0px; font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14px; vertical-align: middle; border: 0px; display: block; position: relative;"><span style="margin: 0px; padding: 0px; color: rgb(133, 153, 0);">var</span> set = <span style="margin: 0px; padding: 0px; color: rgb(133, 153, 0);">new</span> <span style="margin: 0px; padding: 0px; color: rgb(38, 139, 210);">Set</span>();
set.add(<span style="margin: 0px; padding: 0px; color: rgb(38, 139, 210);">window</span>);
set.has(<span style="margin: 0px; padding: 0px; color: rgb(38, 139, 210);">window</span>); <span style="margin: 0px; padding: 0px; color: rgb(153, 153, 153);">// true</span>
set.size; <span style="margin: 0px; padding: 0px; color: rgb(153, 153, 153);">// 1</span>
set.add(<span style="margin: 0px; padding: 0px; color: rgb(38, 139, 210);">window</span>);
set.add(<span style="margin: 0px; padding: 0px; color: rgb(42, 161, 152);">1</span>);
set.size; <span style="margin: 0px; padding: 0px; color: rgb(153, 153, 153);">// 2</span>
set.delete(<span style="margin: 0px; padding: 0px; color: rgb(38, 139, 210);">window</span>);
set.has(<span style="margin: 0px; padding: 0px; color: rgb(38, 139, 210);">window</span>); <span style="margin: 0px; padding: 0px; color: rgb(153, 153, 153);">// false</span>
set.clear();
set.size; <span style="margin: 0px; padding: 0px; color: rgb(153, 153, 153);">// 0</span></code></pre><p style="margin: 15px 0px 0px; padding: 0px; color: rgb(68, 68, 68); font-family: Arial, &quot;Hiragino Sans GB&quot;, 冬青黑, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Helvetica, Tahoma, &quot;Arial sans-serif&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">Set 调用 add、has、delete 等方法时对 key 进行的比较，不做类型转换。可以认为使用「===」进行比较，当然也不全是「===」：</p><ul style="margin: 15px 0px 0px 25px; padding: 0px; color: rgb(68, 68, 68); font-family: Arial, &quot;Hiragino Sans GB&quot;, 冬青黑, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Helvetica, Tahoma, &quot;Arial sans-serif&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="margin: 0px; padding: 0px;">Set 中，NaN 只能添加一次（虽然NaN === NaN 返回 false）；</li><li style="margin: 0px; padding: 0px;">Set 中，「-0」和「0 或 +0」可以同时存在，因为符号不一样（虽然 -0 === 0 或 -0 === +0 返回 true）；</li></ul><h3 style="margin: 15px 0px 0px; padding: 0px; font-size: 1.3em; color: rgb(68, 68, 68); font-family: Arial, &quot;Hiragino Sans GB&quot;, 冬青黑, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Helvetica, Tahoma, &quot;Arial sans-serif&quot;; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><a name="toc-1" style="margin: 0px; padding: 0px; color: rgb(36, 121, 204); text-decoration: none;"></a>Map</h3><p style="margin: 15px 0px 0px; padding: 0px; color: rgb(68, 68, 68); font-family: Arial, &quot;Hiragino Sans GB&quot;, 冬青黑, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Helvetica, Tahoma, &quot;Arial sans-serif&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">Map 是 ES6 新增的有序键值对集合。键值对的 key 和 value 都可以是任何类型的元素。通过 set(key, value) 方法为 Map 设置新的键值对，如果设置的 key 已经存在则用新的 value 覆盖，Map 在比较 key 时也不做类型转换，跟 Set 类似；Map 的 get(key) 方法用来获取指定 key 的值；Map 的 has(key) 、 delete(key) 、clear() 这些方法和 size 属性，与 Set 类似，直接看代码：</p><pre style="margin: 15px 0px 0px; padding: 0.6em; background-color: rgb(248, 248, 248); border-left: 5px solid rgb(204, 204, 204); color: rgb(93, 106, 106); font-size: 14px; overflow: hidden; position: relative; white-space: pre-wrap; word-break: break-word; word-wrap: break-word; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><b style="margin: 0px; padding: 0px; color: rgb(238, 238, 238); font-family: Consolas, &quot;Liberation Mono&quot;, Courier, monospace; font-size: 60px; pointer-events: none; position: absolute; right: 10px; top: 10px;">JS</b><code style="margin: 0px; padding: 0px; background-color: transparent; border-radius: 0px; font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14px; vertical-align: middle; border: 0px; display: block; position: relative;"><span style="margin: 0px; padding: 0px; color: rgb(133, 153, 0);">var</span> map = <span style="margin: 0px; padding: 0px; color: rgb(133, 153, 0);">new</span> <span style="margin: 0px; padding: 0px; color: rgb(38, 139, 210);">Map</span>();
<span style="margin: 0px; padding: 0px; color: rgb(133, 153, 0);">var</span> key1 = {toString : <span style="margin: 0px; padding: 0px;"><span style="margin: 0px; padding: 0px; color: rgb(133, 153, 0);">function</span><span style="margin: 0px; padding: 0px;">()</span> </span>{ <span style="margin: 0px; padding: 0px; color: rgb(133, 153, 0);">return</span> <span style="margin: 0px; padding: 0px; color: rgb(42, 161, 152);">2</span>}};
<span style="margin: 0px; padding: 0px; color: rgb(133, 153, 0);">var</span> key2 = <span style="margin: 0px; padding: 0px; color: rgb(42, 161, 152);">2</span>;
map.set(key1, <span style="margin: 0px; padding: 0px; color: rgb(42, 161, 152);">1</span>);
map.set(key2, <span style="margin: 0px; padding: 0px; color: rgb(42, 161, 152);">2</span>);

map.has(key1); <span style="margin: 0px; padding: 0px; color: rgb(153, 153, 153);">// true</span>
map.has(<span style="margin: 0px; padding: 0px; color: rgb(42, 161, 152);">'2'</span>); <span style="margin: 0px; padding: 0px; color: rgb(153, 153, 153);">// false，类型不同</span>
map.delete(<span style="margin: 0px; padding: 0px; color: rgb(42, 161, 152);">2</span>);
map.size; <span style="margin: 0px; padding: 0px; color: rgb(153, 153, 153);">// 1</span>
map.get(key2); <span style="margin: 0px; padding: 0px; color: rgb(153, 153, 153);">// undefined</span></code></pre><h3 style="margin: 15px 0px 0px; padding: 0px; font-size: 1.3em; color: rgb(68, 68, 68); font-family: Arial, &quot;Hiragino Sans GB&quot;, 冬青黑, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Helvetica, Tahoma, &quot;Arial sans-serif&quot;; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><a name="toc-2" style="margin: 0px; padding: 0px; color: rgb(36, 121, 204); text-decoration: none;"></a>迭代</h3><p style="margin: 15px 0px 0px; padding: 0px; color: rgb(68, 68, 68); font-family: Arial, &quot;Hiragino Sans GB&quot;, 冬青黑, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Helvetica, Tahoma, &quot;Arial sans-serif&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">我们没办法像数组一样用 for 循环来迭代 Set，也没办法像对象一样用 for...in 来迭代 Map。但是可以用 ES6 提供的新方法 for...of 来遍历它们。</p><p style="margin: 15px 0px 0px; padding: 0px; color: rgb(68, 68, 68); font-family: Arial, &quot;Hiragino Sans GB&quot;, 冬青黑, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Helvetica, Tahoma, &quot;Arial sans-serif&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">Set 和 Map 有几个方法会返回可迭代对象（Iterator Objects），分别是 entries()、keys() 和 values()。直接遍历 Set/Map，等同于遍历 entries()；keys() 和 values() 则分别返回 key 和 value 的集合；对于 Set，key 和 value 是一样的。这些方法和 for...of 现阶段都只有 Firefox 支持，下面的例子需要在 Firefox 下运行：</p><pre style="margin: 15px 0px 0px; padding: 0.6em; background-color: rgb(248, 248, 248); border-left: 5px solid rgb(204, 204, 204); color: rgb(93, 106, 106); font-size: 14px; overflow: hidden; position: relative; white-space: pre-wrap; word-break: break-word; word-wrap: break-word; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><b style="margin: 0px; padding: 0px; color: rgb(238, 238, 238); font-family: Consolas, &quot;Liberation Mono&quot;, Courier, monospace; font-size: 60px; pointer-events: none; position: absolute; right: 10px; top: 10px;">JS</b><code style="margin: 0px; padding: 0px; background-color: transparent; border-radius: 0px; font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14px; vertical-align: middle; border: 0px; display: block; position: relative;"><span style="margin: 0px; padding: 0px; color: rgb(133, 153, 0);">var</span> set = <span style="margin: 0px; padding: 0px; color: rgb(133, 153, 0);">new</span> <span style="margin: 0px; padding: 0px; color: rgb(38, 139, 210);">Set</span>();
set.add(<span style="margin: 0px; padding: 0px; color: rgb(42, 161, 152);">'this is a demo.'</span>);
set.add(<span style="margin: 0px; padding: 0px; color: rgb(38, 139, 210);">window</span>);
set.add(top);

<span style="margin: 0px; padding: 0px; color: rgb(133, 153, 0);">for</span>(<span style="margin: 0px; padding: 0px; color: rgb(133, 153, 0);">let</span> item <span style="margin: 0px; padding: 0px; color: rgb(133, 153, 0);">of</span> set) {
    <span style="margin: 0px; padding: 0px; color: rgb(38, 139, 210);">console</span>.log(item);
}
</code></pre><h3 style="margin: 15px 0px 0px; padding: 0px; font-size: 1.3em; color: rgb(68, 68, 68); font-family: Arial, &quot;Hiragino Sans GB&quot;, 冬青黑, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Helvetica, Tahoma, &quot;Arial sans-serif&quot;; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><a name="toc-3" style="margin: 0px; padding: 0px; color: rgb(36, 121, 204); text-decoration: none;"></a>WeakMap</h3><p style="margin: 15px 0px 0px; padding: 0px; color: rgb(68, 68, 68); font-family: Arial, &quot;Hiragino Sans GB&quot;, 冬青黑, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Helvetica, Tahoma, &quot;Arial sans-serif&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">WeakMap 相对于普通的 Map，也是键值对集合，只不过 WeakMap 的 key 只能是非空对象（non-null object）。WeakMap 对它的 key 仅保持弱引用，也就是说它不阻止垃圾回收器回收它所引用的 key。WeakMap 最大的好处是可以避免内存泄漏。一个仅被 WeakMap 作为 key 而引用的对象，会被垃圾回收器回收掉。</p><p style="margin: 15px 0px 0px; padding: 0px; color: rgb(68, 68, 68); font-family: Arial, &quot;Hiragino Sans GB&quot;, 冬青黑, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Helvetica, Tahoma, &quot;Arial sans-serif&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">WeakMap 拥有和 Map 类似的 set(key, value) 、get(key)、has(key)、delete(key) 和 clear() 方法，但没有 size 属性，也没有任何与迭代有关的方法。</p><p style="margin: 15px 0px 0px; padding: 0px; color: rgb(68, 68, 68); font-family: Arial, &quot;Hiragino Sans GB&quot;, 冬青黑, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Helvetica, Tahoma, &quot;Arial sans-serif&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">为了演示 WeakMap 与内存回收的关系，我用 IE11 做了一个简单的测试。IE11 的 F12 开发者工具改进很大，下次找机会单独介绍。测试流程如下：</p><ol style="margin: 15px 0px 0px 25px; padding: 0px; color: rgb(68, 68, 68); font-family: Arial, &quot;Hiragino Sans GB&quot;, 冬青黑, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Helvetica, Tahoma, &quot;Arial sans-serif&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="margin: 0px; padding: 0px;">创建一个全局的 Map/WeakMap 对象；</li><li style="margin: 0px; padding: 0px;">进入局部作用域，创建大量对象作为 key，加到 Map/WeakMap 中；</li><li style="margin: 0px; padding: 0px;">离开局部作用域，检查第 2 步创建的大量对象是否被回收；</li><li style="margin: 0px; padding: 0px;">手动回收 Map/WeakMap 对象；</li></ol><p style="margin: 15px 0px 0px; padding: 0px; color: rgb(68, 68, 68); font-family: Arial, &quot;Hiragino Sans GB&quot;, 冬青黑, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Helvetica, Tahoma, &quot;Arial sans-serif&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">内存使用结果如下：</p><p style="margin: 15px 0px 0px; padding: 0px; color: rgb(68, 68, 68); font-family: Arial, &quot;Hiragino Sans GB&quot;, 冬青黑, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Helvetica, Tahoma, &quot;Arial sans-serif&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><img alt="map &amp; weakmap" height="461" src="https://st.imququ.com/i/webp/static/uploads/2013/09/Screen-Shot-2013-09-22-at-18.09.03_2.png.webp" style="margin: 10px 0px 5px; padding: 0px; border: 1px solid rgb(204, 204, 204); display: block; max-width: 100%; height: auto !important;" width="393"></img></p><p style="margin: 15px 0px 0px; padding: 0px; color: rgb(68, 68, 68); font-family: Arial, &quot;Hiragino Sans GB&quot;, 冬青黑, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Helvetica, Tahoma, &quot;Arial sans-serif&quot;; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">红线位置即为测试的第 2 步，可以看到给 Map/WeakMap 添加大量对象后，内存使用大幅增加；但 WeakMap 没有阻止这些对象随后被回收，内存使用马上跌落，与 Map 对比非常明显；最后手动回收 Map/WeakMap 之后，全部内存都会被回收。</p><h3 style="margin: 15px 0px 0px; padding: 0px; font-size: 1.3em; color: rgb(68, 68, 68); font-family: Arial, &quot;Hiragino Sans GB&quot;, 冬青黑, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Helvetica, Tahoma, &quot;Arial sans-serif&quot;; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><a name="toc-4" style="margin: 0px; padding: 0px; color: rgb(36, 121, 204); text-decoration: none;"></a>WeakSet？</h3></div><div><br/></div><div style="margin: 15px 0px 0px; padding: 0px; color: rgb(68, 68, 68); font-family: Arial, 'Hiragino Sans GB', 冬青黑, 'Microsoft YaHei', 微软雅黑, SimSun, 宋体, Helvetica, Tahoma, 'Arial sans-serif'; font-size: 16px; font-style: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div>ES6 还定义了另外一种集合类型：<a href="http://people.mozilla.org/~jorendorff/es6-draft.html#sec-23.4" style="margin: 0px; padding: 0px; color: rgb(36, 121, 204); text-decoration: none;">WeakSet</a>，但目前还没有浏览器实现。顾名思义，它应该是没有 size 属性、不能迭代的 Set；且只能添加非空对象。这里有 <a href="https://code.google.com/p/v8/source/browse/trunk/src/collection.js" style="margin: 0px; padding: 0px; color: rgb(36, 121, 204); text-decoration: none;">V8 引擎实现 WeakSet 的代码</a>，大家可以先看看。</div></div></span>
</div></body></html> 