<html>
<head>
  <title>3-视频笔记</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/304720 (zh-CN, DDL); Windows/10.0.14393 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="724"/>
<h1>3-视频笔记</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2017/4/12 星期三 16:54</i></td></tr>
<tr><td><b>更新时间：</b></td><td><i>2017/4/12 星期三 16:54</i></td></tr>
<tr><td><b>作者：</b></td><td><i>王平安</i></td></tr>
</table>
</div>
<br/>

<div>
<span><div><div align="justify" style="min-height: 10pt;"><font color="#010101" face="Times New Roman" size="1"><span style="font-size:9pt"> </span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">mongodb</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">memcached</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">redis        kv数据库(key/value)</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">mongodb 文档数据库,存储的是文档(Bson-&gt;json的二进制化).</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">特点:内部执行引擎为JS解释器, 把文档存储成bson结构,在查询时,转换为JS对象,并可以通过熟悉的js语法来操作.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">mongo和传统型数据库相比,最大的不同:</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">传统型数据库: 结构化数据, 定好了表结构后,每一行的内容,必是符合表结构的,就是说--列的个数,类型都一样.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">mongo文档型数据库: 表下的每篇文档,都可以有自己独特的结构(json对象都可以有自己独特的属性和值)</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">思路: 如果有电影, 影评, 影评的回复, 回复的打分</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">在传统型数据库中, 至少要4张表, 关联度非常复杂.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">在文档数据库中,通过1篇文档,即可完成.  体现出文档型数据库的反范式化.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt"> fiim:</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">’</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">天龙八部</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">’</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt"> comment:[</span></font></div><div align="justify" style="margin-left:7mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{content:</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">’</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">王家卫的电影风格</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">’</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">,</span></font></div><div align="justify" style="margin-left:7mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt"> reply:[</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">‘</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">支持</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">’</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">,</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">’</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">好</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">’</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">]</span></font></div><div align="justify" style="margin-left:7mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">}</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">]</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">}</span></font></div><p style="page-break-before:always"></p><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">mongodb的安装</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">1: 下载mongodb</span></font> <a href="http://www.mongodb.org/"><font color="#0000FF" face="Times New Roman" size="2"><span style="font-size:10pt"><u>www.mongodb.org</u></span></font></a><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">  下载最新的stable版</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">2: 解压文件</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">3: 不用编译,本身就是编译后的二进制可执行文件.</span></font></div><div align="justify" style="min-height: 179pt;"><img src="3-视频笔记_files/Image.png" type="image/png" alt="graphic" border="0" height="239" width="481"/></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">4: 启动mongod服务</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">./bin/mongod --dbpath /path/to/database --logpath /path/to/log --fork --port 27017</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">参数解释:</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">--dbpath 数据存储目录</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">--logpath 日志存储目录</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">--port 运行端口(默认27017)</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">--fork 后台进程运行</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">5: mongodb非常的占磁盘空间, 刚启动后要占3-4G左右,</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">如果你用虚拟机练习,可能空间不够,导致无法启动.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">可以用 --smallfiles 选项来启动,</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">将会占用较小空间  400M左右.</span></font></div><p style="page-break-before:always"></p><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">1: mongo入门命令</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">1.1: show dbs  查看当前的数据库</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">1.2 use databaseName 选库</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">1.2 show tables/collections 查看当前库下的collection</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">1.3 如何创建库?</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Mongodb的库是隐式创建,你可以use 一个不存在的库</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">然后在该库下创建collection,即可创建库</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">1.4 db.createCollection(</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">‘</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">collectionName</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">’</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">) </span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">创建collection</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">1.5 collection允许隐式创建</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Db.collectionName.insert(document);</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">1.6 db.collectionName.drop() ,</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">删除collection</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">1.7 db.dropDatabase();</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">删除database</span></font></div><p style="page-break-before:always"></p><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">基本操作增删改查</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">增: insert</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">介绍: mongodb存储的是文档,. 文档是json格式的对象.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">语法: db.collectionName.isnert(document);</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">1: 增加单篇文档</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Db.collectionName.insert({title:</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">’</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">nice day</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">’</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">});</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">2: 增加单个文档,并指定_id</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Db.collectionName.insert({_id:8,age:78,name:</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">’</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">lisi</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">’</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">});</span></font></div><ol start="3" style="margin-top: 0mm; margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 15pt; margin-right: 0pt; padding-left: -18pt; text-indent:0pt; font-family: ����; font-size: 10pt; color: #010101;"><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt; font-family:����; color:#010101; font-weight:Normal; font-style:Normal; font-decoration:Normal">增加多个文档</span></font></div></li></ol><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">db.collectionName.insert(</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">[</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{time:'friday',study:'mongodb'},</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{_id:9,gender:'male',name:'QQ'}</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">]</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">)</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">删:remove</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">语法: db.collection.remove(查询表达式, 选项);</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">选项是指  {justOne:true/false},是否只删一行, 默认为false</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">注意</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">1: 查询表达式依然是个json对象</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">2: 查询表达式匹配的行,将被删掉.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">3: 如果不写查询表达式,collections中的所有文档将被删掉.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">例1: db.stu.remove({sn:</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">’</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">001</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">’</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">});</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">删除stu表中 sn属性值为</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">’</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">001</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">’</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">的文档</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">例2: db.stu.remove({gender:</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">’</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">m</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">’</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">,true});</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">删除stu表中gender属性为m的文档,只删除1行.</span></font></div><p style="page-break-before:always"></p><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">改  update操作</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">改谁? --- 查询表达式</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">改成什么样? -- 新值 或 赋值表达式</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">操作选项 ----- 可选参数</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">语法: db.collection.update(查询表达式,新值,选项);</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">例:</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">db.news.update({name:'QQ'},{name:'MSN'});</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">是指选中news表中,name值为QQ的文档,并把其文档值改为{name:</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">’</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">MSN</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">’</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">},</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#FF0000" face="宋体" size="2"><span style="font-size:10pt">结果: 文档中的其他列也不见了,改后只有_id和name列了.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">即--新文档直接替换了旧文档,而不是修改</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">如果是想修改文档的某列,可以用$set关键字</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">db.collectionName.update(query,{$set:{name:</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">’</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">QQ</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">’</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">}})</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">修改时的赋值表达式</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">$set  修改某列的值</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">$unset 删除某个列</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">$rename 重命名某个列</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">$inc 增长某个列</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">$setOnInsert 当upsert为true时,并且发生了insert操作时,可以补充的字段.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Option的作用:</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{upsert:true/false,multi:true/false}</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Upsert---是指没有匹配的行,则直接插入该行.(和mysql中的replace一样)</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">例:db.stu.update({name:'wuyong'},{$set:{name:'junshiwuyong'}},{upsert:true});</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">如果有name=</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">’</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">wuyong</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">’</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">的文档,将被修改</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">如果没有,将添加此新文档</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">例:</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">db.news.update({_id:99},{x:123,y:234},{upsert:true});</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">没有_id=99的文档被修改,因此直接插入该文档</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">multi: 是指修改多行(即使查询表达式命中多行,默认也只改1行,如果想改多行,可以用此选项)</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">例:</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">db.news.update({age:21},{$set:{age:22}},{multi:true});</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">则把news中所有age=21的文档,都修改</span></font></div><p style="page-break-before:always"></p><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">查: find, findOne</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">语法: db.collection.find(查询表达式,查询的列);</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Db.collections.find(表达式,{列1:1,列2:1});</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">例1:db.stu.find()</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">查询所有文档 所有内容</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">例2: db.stu.find({},{gendre:1})</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">查询所有文档,的gender属性 (_id属性默认总是查出来)</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">例3: db.stu.find({},{gender:1, _id:0})</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">查询所有文档的gender属性,且不查询_id属性</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">例3: db.stu.find({gender:</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">’</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">male</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">’</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">},{name:1,_id:0});</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">查询所有gender属性值为male的文档中的name属性</span></font></div><p style="page-break-before:always"></p><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">查询表达式:</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">1: 最简单的查询表达式</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{filed:value} ,是指查询field列的值为value的文档</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">2: $ne --- != 查询表达式</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{field:{$nq:value}}</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">作用--查filed列的值</span></font> <font color="#FF0000" face="宋体" size="2"><span style="font-size:10pt">不等于</span></font> <font color="#010101" face="宋体" size="2"><span style="font-size:10pt">value 的文档</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">3: $nin --&gt; not in</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">4: $all</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">语法: {field:{$all:[v1,v2..]}}</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">是指取出 field列是一个数组,且至少包含 v1,v2值</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">5: $exists</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">语法: {field:{$exists:1}}</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">作用: 查询出含有field字段的文档</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">6: $nor,</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{$nor,[条件1,条件2]}</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">是指  所有条件都不满足的文档为真返回</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">7:用正则表达式查询 以</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">”</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">诺基亚</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">”</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">开头的商品</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">例:db.goods.find({goods_name:/诺基亚.*/},{goods_name:1});</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">8: 用$where表达式来查询</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">例: db.goods.find({$where:'this.cat_id != 3 &amp;&amp; this.cat_id != 11'});</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#FF0000" face="宋体" size="2"><span style="font-size:10pt">注意: 用$where查询时, mongodb是把bson结构的二进制数据转换为json结构的对象,</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#FF0000" face="宋体" size="2"><span style="font-size:10pt">然后比较对象的属性是否满足表达式.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#FF0000" face="宋体" size="2"><span style="font-size:10pt">速度较慢</span></font></div><p style="page-break-before:always"></p><div align="justify" style="min-height: 15pt;"><font color="#FF0000" face="宋体" size="2"><span style="font-size:10pt">Update时可用的操作符</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#FF0000" face="宋体" size="2"><span style="font-size:10pt">例:</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">-&gt;db.user.insert({name:'lisi',age:12,sex:'male',height:123,area:'haidian'});</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">-&gt;db.user.update({name:'lisi'},{$set:{area:'chaoyang'},$unset:{height:1},$inc:{age:1},$rename:{sex:'gender'}});</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">&gt; db.user.find();</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{ &quot;_id&quot; : ObjectId(&quot;51fc01c4f5de93e1f2856e33&quot;), &quot;age&quot; : 13, &quot;area&quot; : &quot;chaoyang&quot;, &quot;gender&quot; : &quot;male&quot;, &quot;name&quot; : &quot;lisi&quot; }</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">$setOnInsert -&gt;相当于mysql中的列的默认值</span></font></div><p style="page-break-before:always"></p><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">游标操作   cursor</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">游标是什么\?</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">通俗的说,游标不是查询结果,而是查询的返回资源,或者接口.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">通过这个接口,你可以逐条读取.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">就像php中的fopen打开文件,得到一个资源一样, 通过资源,可以一行一行的读文件.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">声明游标:</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">var cursor =  db.collectioName.find(query,projection);</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Cursor.hasNext() ,判断游标是否已经取到尽头</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Cursor. Next() , 取出游标的下1个单元</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">用while来循环游标</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">&gt; var mycursor = db.bar.find({_id:{$lte:5}})</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">&gt; while(mycursor.hasNext()) {</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">... printjson(mycursor.next());</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">... }</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">例:</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">// 声明游标</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">var cursor = db.goods.find();</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">// 循环游标</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">for(var doc=true;cursor.hasNext();) { printjson(cursor.next());}</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">也可以简写:</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">for(var  cursor=db.goods.find(), doc=true;cursor.hasNext();) { printjson(cursor.next());}</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">游标还有一个迭代函数,允许我们自定义回调函数来逐个处理每个单元.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">cursor.forEach(回调函数);</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">例:</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">&gt; var gettitle = function(obj) {print(obj.goods_name)}</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">&gt; var cursor = db.goods.find();</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">&gt; cursor.forEach(gettitle);</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">游标在分页中的应用</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">比如查到10000行,跳过100页,取10行.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">一般地,我们假设每页N行, 当前是page页</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">就需要跳过前 (page-1)*N 行, 再取N行, 在mysql中, limit offset,N来实现</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">在mongo中,用skip(), limit()函数来实现的</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">如 var mycursor = db.bar.find().skip(9995);</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">则是查询结果中,跳过前9995行</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">查询第901页,每页10条</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">则是 var mytcursor = db.bar.find().skip(9000).limit(10);</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">通过cursor一次性得到所有数据, 并返回数组.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">例:</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">&gt;var cursor = db.goods.find();</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">&gt; printjson(cursor.toArray());  //看到所有行</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">&gt; printjson(cursor.toArray()[2]);  //看到第2行</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">注意: 不要随意使用toArray()</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">原因: 会把所有的行立即以对象形式组织在内存里.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">可以在取出少数几行时,用此功能.</span></font></div><p style="page-break-before:always"></p><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">索引创建</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">1:索引提高查询速度,降低写入速度,权衡常用的查询字段,不必在太多列上建索引</span></font></div><ol start="2" style="margin-top: 0mm; margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 15pt; margin-right: 0pt; padding-left: -18pt; text-indent:0pt; font-family: ����; font-size: 10pt; color: #010101;"><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt; font-family:����; color:#010101; font-weight:Normal; font-style:Normal; font-decoration:Normal">在mongodb中,索引可以按字段升序/降序来创建,便于排序</span></font></div></li><li style="margin-left: 15pt; margin-right: 0pt; padding-left: -18pt; text-indent:0pt; font-family: ����; font-size: 10pt; color: #010101;"><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt; font-family:����; color:#010101; font-weight:Normal; font-style:Normal; font-decoration:Normal">默认是用btree来组织索引文件,2.4版本以后,也允许建立hash索引.</span></font></div></li></ol><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">查看查询计划</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">db.find(query).explain();</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">&quot;cursor&quot; : &quot;BasicCursor&quot;, ----说明没有索引发挥作用</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">&quot;nscannedObjects&quot; : 1000 ---理论上要扫描多少行</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">cursor&quot; : &quot;BtreeCursor sn_1&quot;, 用到的btree索引</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">常用命令:</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">查看当前索引状态: db.collection.getIndexes();</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">创建普通的单列索引:db.collection.ensureIndex({field:1/-1});  1是升续 2是降续</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">删除单个索引</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">db.collection.dropIndex({filed:1/-1});</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">一下删除所有索引</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">db.collection.dropIndexes();</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">创建多列索引  db.collection.ensureIndex({field1:1/-1, field2:1/-1});</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">创建子文档索引</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">db.collection.ensureIndex({filed.subfield:1/-1});</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">创建唯一索引:</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">db.collection.ensureIndex({filed.subfield:1/-1},</span></font> <font color="#FF0000" face="宋体" size="2"><span style="font-size:10pt">{unique:true}</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">);</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">创建稀疏索引:</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">稀疏索引的特点------如果针对field做索引,针对不含field列的文档,将不建立索引.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">与之相对,普通索引,会把该文档的field列的值认为NULL,并建索引.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">适宜于: 小部分文档含有某列时.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">db.collection.ensureIndex({field:1/-1},{sparse:true});</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">&gt; db.tea.find();</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{ &quot;_id&quot; : ObjectId(&quot;5275f99b87437c610023597b&quot;), &quot;email&quot; : &quot;a@163.com&quot; }</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{ &quot;_id&quot; : ObjectId(&quot;5275f99e87437c610023597c&quot;), &quot;email&quot; : &quot;b@163.com&quot; }</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{ &quot;_id&quot; : ObjectId(&quot;5275f9e887437c610023597e&quot;), &quot;email&quot; : &quot;c@163.com&quot; }</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{ &quot;_id&quot; : ObjectId(&quot;5275fa3887437c6100235980&quot;) }</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">如上内容,最后一行没有email列,</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">如果分别加普通索引,和稀疏索引,</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">对于最后一行的email分别当成null 和 忽略最后一行来处理.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">根据{email:null}来查询,前者能查到,而稀疏索引查不到最后一行.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">创建哈希索引(2.4新增的)</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">哈希索引速度比普通索引快,但是,无能对范围查询进行优化.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">适宜于---随机性强的散列</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">db.collection.ensureIndex({file:</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">’</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">hashed</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">’</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">});</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">重建索引</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">一个表经过很多次修改后,导致表的文件产生空洞,索引文件也如此.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">可以通过索引的重建,减少索引文件碎片,并提高索引的效率.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">类似mysql中的optimize table</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">db.collection.reIndex()</span></font></div><p style="page-break-before:always"></p><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Mongodb导出与导入</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">1: 导入/导出可以操作的是本地的mongodb服务器,也可以是远程的.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">所以,都有如下通用选项:</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">-h host   主机</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">--port port    端口</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">-u username 用户名</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">-p passwd   密码</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">2: mongoexport 导出json格式的文件</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">问: 导出哪个库,哪张表,哪几列,哪几行?</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">-d  库名</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">-c  表名</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">-f  field1,field2...列名</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">-q  查询条件</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">-o  导出的文件名</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">-- csv  导出csv格式(便于和传统数据库交换数据)</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">例:</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">[root@localhost mongodb]# ./bin/mongoexport -d test -c news -o test.json</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">connected to: 127.0.0.1</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">exported 3 records</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">[root@localhost mongodb]# ls</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">bin  dump  GNU-AGPL-3.0  README  test.json  THIRD-PARTY-NOTICES</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">[root@localhost mongodb]# more test.json</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{ &quot;_id&quot; : { &quot;$oid&quot; : &quot;51fc59c9fecc28d8316cfc03&quot; }, &quot;title&quot; : &quot;aaaa&quot; }</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{ &quot;_id&quot; : { &quot;$oid&quot; : &quot;51fcaa3c5eed52c903a91837&quot; }, &quot;title&quot; : &quot;today is sataday&quot; }</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{ &quot;_id&quot; : { &quot;$oid&quot; : &quot;51fcaa445eed52c903a91838&quot; }, &quot;title&quot; : &quot;ok now&quot; }</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">例2: 只导出goods_id,goods_name列</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">./bin/mongoexport -d test -c goods -f goods_id,goods_name -o goods.json</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">例3: 只导出价格低于1000元的行</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">./bin/mongoexport -d test -c goods -f goods_id,goods_name,shop_price -q</span></font> <font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">‘</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{shop_price:{$lt:200}}</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">’</span></font> <font color="#010101" face="宋体" size="2"><span style="font-size:10pt">-o goods.json</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">注: _id列总是导出</span></font></div><p style="page-break-before:always"></p><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Mongoimport 导入</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">-d 待导入的数据库</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">-c 待导入的表(不存在会自己创建)</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">--type  csv/json(默认)</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">--file 备份文件路径</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">例1: 导入json</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">./bin/mongoimport -d test -c goods --file ./goodsall.json</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">例2: 导入csv</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">./bin/mongoimport -d test -c goods --type csv -f goods_id,goods_name --file ./goodsall.csv</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">./bin/mongoimport -d test -c goods --type csv --headline -f goods_id,goods_name --file ./goodsall.csv</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">mongodump 导出二进制bson结构的数据及其索引信息</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">-d  库名</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">-c  表名</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">-f  field1,field2...列名</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">例:</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">mongodum -d test  [-c 表名]  默认是导出到mongo下的dump目录</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">规律:</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">1:导出的文件放在以database命名的目录下</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">2: 每个表导出2个文件,分别是bson结构的数据文件, json的索引信息</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">3: 如果不声明表名, 导出所有的表</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">mongorestore 导入二进制文件</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">例:</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt"> ./bin/mongorestore -d test --directoryperdb</span></font> <font color="#0000FF" face="宋体" size="2"><span style="font-size:10pt">dump/test/</span></font> <font color="#010101" face="宋体" size="2"><span style="font-size:10pt">(mongodump时的备份目录)</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">二进制备份,不仅可以备份数据,还可以备份索引,</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">备份数据比较小.</span></font></div><p style="page-break-before:always"></p><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">mongodb的用户管理</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">注意:</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">A)在mongodb中,有一个admin数据库, 牵涉到服务器配置层面的操作,需要先切换到admin数据.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">即 use admin , --&gt;相当于进入超级用户管理模式.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">B)mongo的用户是以数据库为单位来建立的, 每个数据库有自己的管理员.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">C) 我们在设置用户时,需要先在admin数据库下建立管理员---这个管理员登陆后,相当于超级管理员.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">0: 查看用户</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">1: 添加用户</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">命令:db.addUser();</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">简单参数: db.addUser(用户名,密码,是否只读)</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#0000FF" face="宋体" size="2"><span style="font-size:10pt">注意: 添加用户后,我们再次退出并登陆,发现依然可以直接读数据库?</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#0000FF" face="宋体" size="2"><span style="font-size:10pt">原因: mongodb服务器启动时, 默认不是需要认证的.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">要让用户生效, 需要启动服务器时,就指定</span></font> <font color="#FF0000" face="宋体" size="2"><span style="font-size:10pt">--auth</span></font> <font color="#010101" face="宋体" size="2"><span style="font-size:10pt">选项.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">这样, 操作时,就需要认证了.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">例:</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">1: 添加用户</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">&gt; use admin</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">&gt; db.addUser(</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">‘</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">sa</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">’</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">,</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">’</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">sa</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">’</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">,false);</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">2: 认证</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">&gt; use test</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">&gt; db.auth(用户名,密码);</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">3: 修改用户密码</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">&gt; use test</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">&gt; db.changeUserPassword(用户名, 新密码);</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">3:删除用户</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">&gt; use test</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">&gt; db.removeUser(用户名);</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#FF0000" face="宋体" size="2"><span style="font-size:10pt">注: 如果需要给用户添加更多的权限,可以用json结构来传递用户参数</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">例:</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">&gt; use test</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">&gt;db.addUser({user:'guan',pwd:'111111',roles:['readWrite,dbAdmin']});</span></font></div><p style="page-break-before:always"></p><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">replication set复制集</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">replicattion set 多台服务器维护相同的数据副本,提高服务器的可用性.</span></font></div><div align="justify" style="min-height: 15pt;"><hr align="left"/></div><div style="border-style: solid; border-width: 1px; position: relative; z-index: 1; left: 174px; width: 96px;"><div align="justify" style="min-height: 14pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">primary</span></font></div></div><div align="justify" style="min-height: 15pt;"><hr align="left"/><hr align="left"/></div><div align="justify" style="min-height: 15pt;"><hr align="left"/><hr align="left"/></div><div style="border-style: solid; border-width: 1px; position: relative; z-index: 1; left: 282px; width: 96px; height: 0px;"><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">secondary</span></font></div></div><div style="border-style: solid; border-width: 1px; position: relative; z-index: 1; left: 73px; width: 96px;"><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">secondary</span></font></div></div><div align="justify" style="min-height: 15pt;"><hr align="left" size="1pt" style="color: #739cc3;" width="70"/><hr align="left" size="1pt" style="color: #739cc3;" width="78"/></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Replication set 设置全过程</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">0:创建目录</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">mkdir -p /data/r0 /data/r1 /data/r2</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">1:启动3个实例,且</span></font><font color="#FF0000" face="宋体" size="2"><span style="font-size:10pt">声明实例属于某复制集</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">./bin/mongod --port 27017 --dbpath /data/r0 --smallfiles</span></font> <font color="#0000FF" face="宋体" size="2"><span style="font-size:10pt">--replSet rsa</span></font> <font color="#010101" face="宋体" size="2"><span style="font-size:10pt">--fork --logpath /var/log/mongo17.log</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">./bin/mongod --port 27018 --dbpath /data/r1 --smallfiles</span></font> <font color="#0000FF" face="宋体" size="2"><span style="font-size:10pt">--replSet rsa</span></font> <font color="#010101" face="宋体" size="2"><span style="font-size:10pt">--fork --logpath /var/log/mongo18.log</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">./bin/mongod --port 27019 --dbpath /data/r2 --smallfiles</span></font> <font color="#0000FF" face="宋体" size="2"><span style="font-size:10pt">--replSet rsa</span></font> <font color="#010101" face="宋体" size="2"><span style="font-size:10pt">--fork --logpath /var/log/mongo19.log</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">2:配置</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">rsconf = {</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">    _id:'rsa',</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">    members:</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">    [</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">        {_id:0,</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">        host:'192.168.1.201:27017'</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">        }</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">    ]</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">}</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">3: 根据配置做初始化</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">rs.initiate(rsconf);</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">4: 添加节点</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">rs.add('192.168.1.201:27018');</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">rs.add('192.168.1.201:27019');</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">5:查看状态</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">rs.status();</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">6:删除节点</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">rs.remove('192.168.1.201:27019');</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">7:主节点插入数据</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">&gt;use test</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">&gt;db.user.insert({uid:1,name:'lily'});</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">8:连接secondary查询同步情况</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">./bin/mongo --port 27019</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">&gt;use test</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">&gt;show tables</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">rsa:SECONDARY&gt; show tables;</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Sat Aug 17 16:03:55.786 JavaScript execution failed: error: { &quot;$err&quot; : &quot;not master and slaveOk=false&quot;, &quot;code&quot; : 13435 }</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">8.1 出现上述错误,是因为slave默认不许读写</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">&gt;rs.slaveOk();</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">&gt;show tables</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">#看到与primary 一致的数据</span></font></div><p style="page-break-before:always"></p><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">分片</span></font></div><div align="justify" style="min-height: 409pt;"><img src="3-视频笔记_files/Image [1].png" type="image/png" alt="graphic" border="0" height="546" width="657"/></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">1:在3台独立服务器上,分别运行 27017,27018,27019实例, 互为副本集,形成3套repl set</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">2: 在3台服务器上,各配置config server, 运行27020端口上</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">3: 配置mongos</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">./bin/mongos --port 30000 \</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt"> --dbconfig 192.168.1.201:27020,192.168.1.202:27020,192.168.1.203:27020</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">4:连接路由器</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">./bin/mongo --port 30000</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">5: 添加repl set为片</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">&gt;sh.addShard(</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">‘</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">192.168.1.201:27017</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">’</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">);</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">&gt;sh.addShard(</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">‘</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">192.168.1.203:27017</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">’</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">);</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">&gt;sh.addShard(</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">‘</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">192.168.1.203:27017</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">’</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">);</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">6: 添加待分片的库</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">&gt;sh.enableSharding(databaseName);</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">7: 添加待分片的表</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">&gt;sh.shardCollection(</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">‘</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">dbName.collectionName</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">’</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">,{field:1});</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Field是collection的一个字段,系统将会利用filed的值,来计算应该分到哪一个片上.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">这个filed叫</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">”</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">片键</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">”</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">, shard key</span></font></div><div align="justify" style="min-height: 15pt;"><font face="微软雅黑"><span style="font-size:12pt">mongodb不是从单篇文档的级别,绝对平均的散落在各个片上,</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">而是N篇文档,形成一个块&quot;chunk&quot;,</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">优先放在某个片上,</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">当这片上的chunk,比另一个片的chunk,区别比较大时, (&gt;=3) ,会把本片上的chunk,移到另一个片上, 以chunk为单位,</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">维护片之间的数据均衡</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">问: 为什么插入了10万条数据,才2个chunk?</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">答: 说明chunk比较大(默认是64M)</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">在config数据库中,修改chunksize的值.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">问: 既然优先往某个片上插入,当chunk失衡时,再移动chunk,</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">自然,随着数据的增多,shard的实例之间,有chunk来回移动的现象,这将带来什么问题?</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">答: 服务器之间IO的增加,</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">接上问: 能否我定义一个规则, 某N条数据形成1个块,预告分配M个chunk,</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">M个chunk预告分配在不同片上.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">以后的数据直接入各自预分配好的chunk,不再来回移动?</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">答: 能, 手动预先分片!</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">以shop.user表为例</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">1: sh.shardCollection(</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">‘</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">shop.user</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">’</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">,{userid:1}); //user表用userid做shard key</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">2: for(var i=1;i&lt;=40;i++) { sh.splitAt('shop.user',{userid:i*1000}) } // 预先在1K 2K...40K这样的界限切好chunk(虽然chunk是空的), 这些chunk将会均匀移动到各片上.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">3: 通过mongos添加user数据. 数据会添加到预先分配好的chunk上, chunk就不会来回移动了.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">短网址项目开发准备</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">项目功能:</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">为已有网站生成统一的短网址.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">如 新浪 t.cn  </span></font> <a href="http://t.cn/zQd5NPw"><font color="#0000FF" face="Times New Roman" size="2"><span style="font-size:10pt"><u>http://t.cn/zQd5NPw</u></span></font></a></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">点击短网址 跳转到原始网站</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">攻关点:</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">0:  形如 d.cn/acF54V ---&gt; 统一解析到固定页面上去.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">解决: 在apache中用URL重写, 在nginx中, location</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">1: 如何生成短网址的参数  ,如 zQd5NPw</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">分析:</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt"> 1: 短,</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">2: 为公众服务,储存的网址特别多.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">1,2是相互矛盾的--短自然存储就少.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">所以要合理的设计短网站的组成规律.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">2: 如果跳转.</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">答:302跳转.</span></font></div><div align="justify" style="min-height: 21pt;"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt">网址生成办法:</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">1:用 a-zA-Z0-9 ,,62位 ,</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">考虑成 62进制的数,</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">7位可以存储62^7, 约等于 (2^6)^7</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">约存储4万亿条数据</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">2: 链接编码看起来</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">”</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">无规律一些</span></font><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">”</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">====&gt;  10进制的URL的id,转换为62进制.</span></font></div><p style="page-break-before:always"></p><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">筹备内容:</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">1: 前端页面</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">2: mongodb的建模</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">库: info</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">表: url</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">文档的格式:</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{_id:xxxx,sn:TrE4Q,oriurl:http://www.baidu.com, hits:0}</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">注: sn,oriurl,要加索引,且是唯一索引</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">3: 全局的序号生成器</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">库:info</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">表:globalsn</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{_id:1,sn:0}</span></font></div><p style="page-break-before:always"></p><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">生成生网址</span></font></div><div style="border-style: solid; border-width: 1px; position: relative; z-index: 1; left: 110px; width: 165px;"><div align="justify" style="min-height: 14pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">   ����ԭ��ַ</span></font></div></div><div align="left" style="min-height: 15pt;"><hr align="left"/></div><div style="border-style: solid; border-width: 1px; position: relative; z-index: 1; left: 193px; width: 79px; height: 0px;"><div align="justify" style="min-height: 14pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">����</span></font></div></div><div style="border-style: solid; border-width: 1px; position: relative; z-index: 1; left: 113px; width: 162px; height: 0px;"><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">�����ɶ���ַ,��д��</span></font></div><div align="justify" style="min-height: 14pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Mongodb��ȥ</span></font></div></div><div style="border-style: solid; border-width: 1px; position: relative; z-index: 1; left: 117px; width: 168px; height: 0px;"><div align="justify" style="min-height: 14pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">����ȫ�����к�</span></font></div></div><div style="border-style: solid; border-width: 1px; position: relative; z-index: 1; left: -61px; width: 100px;"><div align="justify" style="min-height: 14pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">���ض���ַ</span></font></div></div><div align="left" style="min-height: 15pt;"><hr align="left"/><hr align="left"/><hr align="left"/></div><p style="page-break-before:always"></p><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">短网址项目移植到mongo集群</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">分片与副本集自动部署</span></font></div><div style="border-style: solid; border-width: 1px; position: relative; z-index: 1; left: 278px; width: 75px; height: 0px;"><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Shard rsd</span></font></div></div><div style="border-style: solid; border-width: 1px; position: relative; z-index: 1; left: 95px; width: 75px; height: 0px;"><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Shard rsb</span></font></div></div><div style="border-style: solid; border-width: 1px; position: relative; z-index: 1; left: 276px; width: 80px; height: 0px;"><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">D�ŷ�</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">IP:204</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">������</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">[27019]</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">[27018]</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">[27017]</span></font></div></div><div style="border-style: solid; border-width: 1px; position: relative; z-index: 1; left: 49px; width: 80px;"><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">B�ŷ�</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">IP:202</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">������</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">[27019]</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">[27018]</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">[27017]</span></font></div></div><div align="justify" style="min-height: 15pt;"><hr align="left"/><hr align="left"/><hr align="left"/><hr align="left"/></div><div style="border-style: solid; border-width: 1px; position: relative; z-index: 1; left: 131px; width: 185px;"><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">A�ŷ� IP: 201</span></font></div><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Mongos  ,configdb</span></font></div><div align="justify" style="min-height: 14pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">[PHP+nginx]</span></font></div></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">                                                    </span></font></div><p style="page-break-before:always"></p><div align="left" style="min-height: 21pt;"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt">Mongodb 分片与chunk</span></font></div><div align="left" style="min-height: 21pt;"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt">问题---我们向mongos路由器,添加了10条数据,发现并没有均匀的分布在B,D两个片上, 而是都在B上.</span></font></div><div align="left" style="min-height: 21pt;"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt">原因: mongodb并不是按行的级别,在片上绝对的平均分配.</span></font></div><div align="left" style="min-height: 21pt;"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt">而是以块为单位,来各片上寻求平衡.</span></font></div><div align="left" style="min-height: 21pt;"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt">过程是这样的--------</span></font></div><div align="left" style="min-height: 21pt;"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt">1: 数据先往主片上添加,都放在一个chunk(块)里, 这个块达到一定大小(默认是64M), 再生成新块.</span></font></div><div align="left" style="min-height: 21pt;"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt">2: 新块仍然是主片上,</span></font></div><div align="left" style="min-height: 21pt;"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt">3: configdb判断主片上有2块,而其他片的chunk过少,则会自动移动chunk过去.</span></font></div><div align="left" style="min-height: 21pt;"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt">在大型系统中,chunk的自动移动,(后台balance程序控制的), 会加剧IO的压力.</span></font></div><div align="left" style="min-height: 21pt;"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt">----我们可以根据业务量,合适的推测数量的增长,对数据进行预先分片, pre-split</span></font></div><div align="left" style="min-height: 21pt;"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt">即手工分片,而不自动分片.</span></font></div><div align="left" style="min-height: 21pt;"><font color="#FF0000" face="宋体" size="4"><span style="font-size:16pt">注意: 预先分片的collection得是空的</span></font></div><div align="left" style="min-height: 21pt;"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt">Use admin  //切换到admin数据库,进行管理</span></font></div><div align="left" style="min-height: 21pt;"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt">db.runCommand({split:</span></font><font color="#010101" face="Times New Roman" size="4"><span style="font-size:16pt">’</span></font><font color="#010101" face="宋体" size="4"><span style="font-size:16pt">database.collection</span></font><font color="#010101" face="Times New Roman" size="4"><span style="font-size:16pt">’</span></font><font color="#010101" face="宋体" size="4"><span style="font-size:16pt">,middle:{_id:值}});</span></font></div><div align="left" style="min-height: 21pt;"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt">例:</span></font></div><div align="left" style="min-height: 21pt;"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt">db.runCommand({split:</span></font><font color="#010101" face="Times New Roman" size="4"><span style="font-size:16pt">’</span></font><font color="#010101" face="宋体" size="4"><span style="font-size:16pt">shop.goods</span></font><font color="#010101" face="Times New Roman" size="4"><span style="font-size:16pt">’</span></font><font color="#010101" face="宋体" size="4"><span style="font-size:16pt">,middle:{_id:10000}});</span></font></div><div align="left" style="min-height: 21pt;"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt">db.runCommand({split:</span></font><font color="#010101" face="Times New Roman" size="4"><span style="font-size:16pt">’</span></font><font color="#010101" face="宋体" size="4"><span style="font-size:16pt">shop.goods</span></font><font color="#010101" face="Times New Roman" size="4"><span style="font-size:16pt">’</span></font><font color="#010101" face="宋体" size="4"><span style="font-size:16pt">,middle:{_id:20000}});</span></font></div><div align="left" style="min-height: 21pt;"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt">....</span></font></div><div align="left" style="min-height: 21pt;"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt">db.runCommand({split:</span></font><font color="#010101" face="Times New Roman" size="4"><span style="font-size:16pt">’</span></font><font color="#010101" face="宋体" size="4"><span style="font-size:16pt">shop.goods</span></font><font color="#010101" face="Times New Roman" size="4"><span style="font-size:16pt">’</span></font><font color="#010101" face="宋体" size="4"><span style="font-size:16pt">,middle:{_id:120000}});</span></font></div><div align="left" style="min-height: 21pt;"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt">这样将会把</span></font></div><div align="left" style="min-height: 21pt;"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt">[0,10000]--&gt;切成1个块chunk</span></font></div><div align="left" style="min-height: 21pt;"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt">(10000,20000]-&gt;切成一个块chunk.</span></font></div><div align="left" style="min-height: 21pt;"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt">....</span></font></div><div align="left" style="min-height: 21pt;"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt">(110000,120000]-&gt;切成一个块chunk.</span></font></div><div align="left" style="min-height: 21pt;"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt">,系统会预告生成这些空块,并在shard片之间达到平衡.</span></font></div><div align="left" style="min-height: 21pt;"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt">然后再插入数据,chunk不会再自动转移.</span></font></div><div align="left" style="min-height: 21pt;"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt">Mongodb的性能监测工具</span></font></div><div align="left" style="min-height: 21pt;"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt">Mongotop 观察N秒内,每个库上读写花费的时间</span></font></div><div align="left" style="min-height: 21pt;"><img src="3-视频笔记_files/Image [2].png" type="image/png" align="left" alt="graphic" border="0" height="223" width="664"/></div><div align="left" style="min-height: 21pt;"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt">Mongostat</span></font></div><div align="left" style="min-height: 21pt;"><img src="3-视频笔记_files/Image [3].png" type="image/png" align="left" alt="graphic" border="0" height="130" width="874"/></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">inserts 每秒插入</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">query 每秒查询</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">update 每秒更新</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">delete 每秒删除</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">getmore 每秒查询游标</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">command 每秒总命令</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">flushes 每秒同步次数</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">mapped mmap内存大小(M)</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">size 虚拟内存(M)</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">res 物理内存(M)</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">faults 取内存页面失败次数(要去swap调)</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">locked db 锁住某库的时间</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">idx miss 索引未命中率</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">qr 队列里读取命令</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">qw 队列里写入命令</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">ar 活动的读取命令</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">aw 活动的读取命令</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">netIn 接收的流量</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">netOut 发出的流量</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">conn 当前打开连接数</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">set 复制集名称</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">repl 在复制集中的名称</span></font></div><div align="left" style="min-height: 18pt;"><font color="#010101" face="宋体" size="4"><span style="font-size:14pt">db.serverStatus();</span></font></div><div align="left" style="min-height: 15pt;"><a href="http://ip:mongod%B6%CB%BF%DA+1000/"><font color="#0000FF" face="Times New Roman" size="2"><span style="font-size:10pt"><u>http://IP:mongod</u></span></font><font color="#0000FF" face="宋体" size="2"><span style="font-size:10pt"><u>端口+1000</u></span></font></a></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">例: http://127.0.0.1:28017</span></font></div><p style="page-break-before:always"></p><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">#查询每个栏目下的商品数量</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">key:{cat_id:1},</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">cond:{},</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">reduce:function(curr,result) {</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">    result.cnt += 1;</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">},</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">initial:{cnt:0}</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">}</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">#查询每个栏目下价格高于50元的商品数量</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">key:{cat_id:1},</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">cond:{shop_price:{$gt:50}},</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">reduce:function(curr,result) {</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">    result.cnt += 1;</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">},</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">initial:{cnt:0}</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">}</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">#每个栏目下的商品库存量 sum()操作</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">key:{cat_id:1},</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">cond:{},</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">reduce:function(curr,result) {</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">    result.num += curr.goods_number;</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">},</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">initial:{num:0}</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">}</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">#查询每个栏目最贵的商品价格, max()操作</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">key:{cat_id:1},</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">cond:{},</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">reduce:function(curr , result) {</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">    if(curr.shop_price &gt; result.max) {</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">        result.max = curr.shop_price;</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">    }</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">},</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">initial:{max:0}</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">}</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">#同上,查询每个栏目下最便宜的商品价格,同学们自行完成</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">#查询每个栏目下商品的平均价格</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">key:{cat_id:1},</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">cond:{},</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">reduce:function(curr , result) {</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">    result.cnt += 1;</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">    result.sum += curr.shop_price;</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">},</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">initial:{sum:0,cnt:0},</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">finalize:function(result) {</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">    result.avg = result.sum/result.cnt;</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">}</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">}</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">#查询每个栏目下的商品数量</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">db.collection.aggregate();</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">[</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{$group:{_id:&quot;$cat_id&quot;,total:{$sum:1}}}</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">]</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">#查询goods下有多少条商品,select count(*) from goods</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">[</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{$group:{_id:null,total:{$sum:1}}}</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">]</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">#查询每个栏目下 价格大于50元的商品个数</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">[</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{$match:{shop_price:{$gt:50}}},</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{$group:{_id:&quot;$cat_id&quot;,total:{$sum:1}}}</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">]</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">#查询每个栏目下 价格大于50元的商品个数</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">#并筛选出&quot;满足条件的商品个数&quot; 大于等于3的栏目</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">[</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{$match:{shop_price:{$gt:50}}},</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{$group:{_id:&quot;$cat_id&quot;,total:{$sum:1}}},</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{$match:{total:{$gte:3}}}</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">]</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">#查询每个栏目下的库存量</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">[</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{$group:{_id:&quot;$cat_id&quot; , total:{$sum:&quot;$goods_number&quot;}}},</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">]</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">#查询每个栏目下的库存量,并按库存量排序</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">[</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{$group:{_id:&quot;$cat_id&quot; , total:{$sum:&quot;$goods_number&quot;}}},</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{$sort:{total:1}}</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">]</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">#查询每个栏目下的库存量,并按库存量排序</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">[</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{$group:{_id:&quot;$cat_id&quot; , total:{$sum:&quot;$goods_number&quot;}}},</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{$sort:{total:1}},</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{$limit:3}</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">]</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">#查询每个栏目的商品平均价格,并按平均价格由高到低排序</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">[</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{$group:{_id:&quot;$cat_id&quot; , avg:{$avg:&quot;$shop_price&quot;}}},</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">{$sort:{avg:-1}}</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">]</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">mapReduce 随着&quot;大数据&quot;概念而流行.</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">其实mapReduce的概念非常简单,</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">从功能上说,相当于RDBMS的 group 操作</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">mapReduce的真正强项在哪?</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">答:在于分布式,当数据非常大时,像google,有N多数据中心,</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">数据都不在地球的一端,用group力所不及.</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">group既然不支持分布式,单台服务器的运算能力必然是有限的.</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">而mapRecuce支持分布式,支持大量的服务器同时工作,</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">用蛮力来统计.</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">mapRecuce的工作过程:</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">map--&gt;映射</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">reduce-&gt;归约</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">map: 先是把属于同一个组的数据,映射到一个数组上.cat_id-3 [23,2,6,7]</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">reduce: 把数组(同一组)的数据,进行运算.</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">用mapReduce计算每个栏目的库存总量</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">map函数</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">var map = function() {</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">    emit(this.cat_id,this.goods_number);</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">    }</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">var reduce = function(cat_id,numbers) {</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">    return Array.sum(numbers);</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">}</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">db.goods.mapReduce(map,reduce,{out:'res'});</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">#用mapReduce计算每个栏目下商品的平均价格</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">var map = function() {</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">    emit(this.cat_id,this.shop_price);</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">    }</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">var reduce = function(cat_id,values) {</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">    return Array.avg(values);</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">}</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">db.goods.mapReduce(map,reduce,{out:'res'});</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">作业:</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">完成2-3个mongod组成的shard集群, 把地震数据分布到各节点上,</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">把中国的区域按10个经度10个纬度为一组, 约为30块,</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">并用mapReduce计算地震数据,</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">统计每一组上,每月的地震次数, 及地震级别</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">分析出结果,把地震高发区用偏红颜色标注, 低发区,用偏绿色标注,</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">分析中国的地震带.</span></font></div><div align="left" style="min-height: 10pt;"><div><font color="#010101" face="Times New Roman" size="1"><span style="font-size:9pt"> </span></font></div></div></div></span>
</div></body></html> 